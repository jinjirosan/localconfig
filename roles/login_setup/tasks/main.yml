---
# Login Setup Role
# Configures login banners, MOTD, and SSH login messages

# Set root group based on OS (FreeBSD uses 'wheel', others use 'root')
- name: Set root group name based on OS
  ansible.builtin.set_fact:
    root_group: "{{ 'wheel' if ansible_facts['os_family'] == 'FreeBSD' else 'root' }}"

- name: Backup existing MOTD
  ansible.builtin.copy:
    src: /etc/motd
    dest: /etc/motd.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] != 'RedHat'
  ignore_errors: yes

- name: Backup existing issue file (RHEL)
  ansible.builtin.copy:
    src: /etc/issue
    dest: /etc/issue.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'
  ignore_errors: yes

- name: Backup existing issue.net file (RHEL)
  ansible.builtin.copy:
    src: /etc/issue.net
    dest: /etc/issue.net.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'
  ignore_errors: yes

# MOTD handling (Debian/Ubuntu/FreeBSD): include safety net and ASCII art generation
# FreeBSD: /etc/motd is often a symlink to /var/run/motd (tmpfs, cleared on reboot)
# We need to replace the symlink with a regular file so the MOTD persists
- name: Check if /etc/motd is a symlink on FreeBSD
  ansible.builtin.stat:
    path: /etc/motd
  register: motd_stat_freebsd
  become: yes
  when: ansible_facts['os_family'] == 'FreeBSD'
  changed_when: false

- name: Backup and remove /etc/motd symlink on FreeBSD, create regular file
  ansible.builtin.shell: |
    if [ -L /etc/motd ]; then
      # Backup the symlink target content if it exists
      if [ -f /var/run/motd ]; then
        cp /var/run/motd /etc/motd.backup.symlink
      fi
      # Remove the symlink
      rm -f /etc/motd
      # Create a regular file
      touch /etc/motd
      chmod 644 /etc/motd
    fi
  become: yes
  when: 
    - ansible_facts['os_family'] == 'FreeBSD'
    - motd_stat_freebsd.stat.islnk is defined
    - motd_stat_freebsd.stat.islnk
  ignore_errors: yes

- name: Check if MOTD exists and get size
  ansible.builtin.stat:
    path: /etc/motd
  register: motd_stat
  become: yes
  when: ansible_facts['os_family'] != 'RedHat'
  changed_when: false

- name: Set facts for MOTD existence and size
  ansible.builtin.set_fact:
    motd_exists: "{{ motd_stat.stat.exists | default(false) }}"
    motd_size: "{{ motd_stat.stat.size | default(0) | int }}"
  when: ansible_facts['os_family'] != 'RedHat'

- name: Install figlet for ASCII art MOTD
  ansible.builtin.package:
    name: figlet
    state: present
  become: yes
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - not (motd_exists | default(false) and (motd_size | default(0) | int) > (motd_size_threshold | default(300) | int))

- name: Generate ASCII art for hostname
  ansible.builtin.shell: |
    figlet -f {{ ascii_font | default('big') }} "{{ ansible_hostname }}"
  register: hostname_ascii_art
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - not (motd_exists | default(false) and (motd_size | default(0) | int) > (motd_size_threshold | default(300) | int))

- name: Set ASCII art fact for hostname
  ansible.builtin.set_fact:
    hostname_ascii: "{{ hostname_ascii_art.stdout | default('') }}"
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - not (motd_exists | default(false) and (motd_size | default(0) | int) > (motd_size_threshold | default(300) | int))

- name: Deploy MOTD template
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - not (motd_exists | default(false) and (motd_size | default(0) | int) > (motd_size_threshold | default(300) | int))

# FreeBSD: Ensure MOTD is displayed correctly
# Check for .hushlogin files that might prevent MOTD display
- name: Check for .hushlogin files that suppress MOTD
  ansible.builtin.find:
    paths:
      - /root
      - /home
    patterns: ".hushlogin"
    file_type: file
    recurse: yes
  register: hushlogin_files
  become: yes
  when: ansible_facts['os_family'] == 'FreeBSD'
  ignore_errors: yes

- name: Remove .hushlogin files to ensure MOTD is displayed
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  become: yes
  when: 
    - ansible_facts['os_family'] == 'FreeBSD'
    - hushlogin_files.files is defined
  loop: "{{ hushlogin_files.files | default([]) }}"
  ignore_errors: yes

# FreeBSD: The default welcome message might be from fortune or other programs
# Check if fortune is being called in profile files
- name: Check for fortune calls in user profile files
  ansible.builtin.shell: |
    find /home /root -maxdepth 2 -name ".profile" -o -name ".bash_profile" -o -name ".bashrc" 2>/dev/null | \
    xargs grep -l "fortune" 2>/dev/null || true
  register: fortune_profiles
  become: yes
  when: ansible_facts['os_family'] == 'FreeBSD'
  changed_when: false
  ignore_errors: yes

- name: Comment out fortune calls in profile files
  ansible.builtin.replace:
    path: "{{ item }}"
    regexp: '^(\s*)(.*fortune.*)'
    replace: '\1# \2'
  become: yes
  when: 
    - ansible_facts['os_family'] == 'FreeBSD'
    - fortune_profiles.stdout is defined
    - fortune_profiles.stdout | length > 0
  loop: "{{ fortune_profiles.stdout_lines | default([]) }}"
  ignore_errors: yes

- name: Skip MOTD deployment - existing MOTD is larger than threshold, assuming custom ASCII art
  ansible.builtin.debug:
    msg: "Skipping MOTD deployment: existing /etc/motd is {{ motd_size }} bytes (threshold: {{ motd_size_threshold | default(300) }})."
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - motd_exists | default(false)
    - (motd_size | default(0) | int) > (motd_size_threshold | default(300) | int)

# Configure issue file for RHEL (pre-login banner)
- name: Deploy issue template (RHEL)
  ansible.builtin.template:
    src: issue.j2
    dest: /etc/issue
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'

# Configure issue.net file for RHEL (SSH pre-login banner)
- name: Deploy issue.net template (RHEL)
  ansible.builtin.template:
    src: issue.net.j2
    dest: /etc/issue.net
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'

# Configure SSH Banner
- name: Check if SSH banner is already configured
  ansible.builtin.shell: grep -q "^Banner" /etc/ssh/sshd_config
  register: ssh_banner_check
  become: yes
  changed_when: false
  failed_when: false

- name: Deploy SSH banner template
  ansible.builtin.template:
    src: ssh_banner.j2
    dest: /etc/ssh/banner
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  notify: restart sshd

- name: Configure SSH to use banner
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/ssh/banner'
    state: present
  become: yes
  notify: restart sshd

- name: Ensure SSH config syntax is valid before restart
  ansible.builtin.command: sshd -t
  become: yes
  register: sshd_config_test
  changed_when: false
  failed_when: sshd_config_test.rc != 0

