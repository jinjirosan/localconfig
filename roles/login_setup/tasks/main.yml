---
# Login Setup Role
# Configures login banners, MOTD, and SSH login messages

# Set root group based on OS (FreeBSD uses 'wheel', others use 'root')
- name: Set root group name based on OS
  ansible.builtin.set_fact:
    root_group: "{{ 'wheel' if ansible_facts['os_family'] == 'FreeBSD' else 'root' }}"

- name: Backup existing MOTD
  ansible.builtin.copy:
    src: /etc/motd
    dest: /etc/motd.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] != 'RedHat'
  ignore_errors: yes

- name: Backup existing issue file (RHEL)
  ansible.builtin.copy:
    src: /etc/issue
    dest: /etc/issue.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'
  ignore_errors: yes

- name: Backup existing issue.net file (RHEL)
  ansible.builtin.copy:
    src: /etc/issue.net
    dest: /etc/issue.net.backup
    remote_src: yes
  become: yes
  when: ansible_facts['os_family'] == 'RedHat'
  ignore_errors: yes

# MOTD handling for all OSes
# FreeBSD: Uses /etc/motd.template which is processed by the motd service
# Debian/Ubuntu: Uses /etc/motd
# RHEL: Uses /etc/issue and /etc/issue.net
# replace_motd variable controls whether to replace existing MOTD (default: yes)

- name: Set default replace_motd if not specified
  ansible.builtin.set_fact:
    replace_motd: "{{ replace_motd | default('yes') }}"

- name: Install figlet for ASCII art MOTD
  ansible.builtin.package:
    name: figlet
    state: present
  become: yes
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - replace_motd | default('yes') | lower == 'yes'

- name: Generate ASCII art for hostname
  ansible.builtin.shell: |
    figlet -f {{ ascii_font | default('big') }} "{{ ansible_hostname }}"
  register: hostname_ascii_art
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - replace_motd | default('yes') | lower == 'yes'

- name: Set ASCII art fact for hostname
  ansible.builtin.set_fact:
    hostname_ascii: "{{ hostname_ascii_art.stdout | default('') }}"
  when:
    - ansible_facts['os_family'] != 'RedHat'
    - ascii_art_enabled | default(true)
    - replace_motd | default('yes') | lower == 'yes'

# FreeBSD: Deploy to /etc/motd.template
- name: Deploy MOTD template (FreeBSD - use motd.template)
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd.template
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] == 'FreeBSD'
    - replace_motd | default('yes') | lower == 'yes'
  register: motd_template_deployed

# FreeBSD: The login process displays "FreeBSD X.X-RELEASE..." before MOTD
# This comes from the login process itself, not from MOTD
# We can suppress it by modifying /etc/gettytab or by using login.conf
# However, the cleanest approach is to write directly to /var/run/motd
# and ensure the motd service doesn't overwrite it with kernel version prepended
- name: Deploy MOTD directly to /var/run/motd (FreeBSD) to bypass service
  ansible.builtin.template:
    src: motd.j2
    dest: /var/run/motd
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] == 'FreeBSD'
    - replace_motd | default('yes') | lower == 'yes'
    - motd_template_deployed.changed is defined
    - motd_template_deployed.changed

# FreeBSD: Disable motd service to prevent it from overwriting our custom MOTD
# The service would prepend kernel version on reboot, so we disable it
- name: Disable motd service on FreeBSD to prevent kernel version prepending
  ansible.builtin.lineinfile:
    path: /etc/rc.conf
    regexp: '^motd_enable='
    line: 'motd_enable="NO"'
    state: present
  become: yes
  when:
    - ansible_facts['os_family'] == 'FreeBSD'
    - replace_motd | default('yes') | lower == 'yes'
  ignore_errors: yes

# Debian/Ubuntu: Deploy to /etc/motd
- name: Deploy MOTD template (Debian/Ubuntu)
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] == 'Debian'
    - replace_motd | default('yes') | lower == 'yes'

# RHEL: Deploy to /etc/issue and /etc/issue.net
- name: Deploy issue template (RHEL)
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/issue
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - replace_motd | default('yes') | lower == 'yes'

- name: Deploy issue.net template (RHEL)
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/issue.net
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - replace_motd | default('yes') | lower == 'yes'

# FreeBSD: Ensure MOTD is displayed correctly
# Check for .hushlogin files that might prevent MOTD display
- name: Check for .hushlogin files that suppress MOTD
  ansible.builtin.find:
    paths:
      - /root
      - /home
    patterns: ".hushlogin"
    file_type: file
    recurse: yes
  register: hushlogin_files
  become: yes
  when: ansible_facts['os_family'] == 'FreeBSD'
  ignore_errors: yes

- name: Remove .hushlogin files to ensure MOTD is displayed
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  become: yes
  when: 
    - ansible_facts['os_family'] == 'FreeBSD'
    - hushlogin_files.files is defined
  loop: "{{ hushlogin_files.files | default([]) }}"
  ignore_errors: yes

# FreeBSD: The default welcome message might be from fortune or other programs
# Check if fortune is being called in profile files
- name: Check for fortune calls in user profile files
  ansible.builtin.shell: |
    find /home /root -maxdepth 2 -name ".profile" -o -name ".bash_profile" -o -name ".bashrc" 2>/dev/null | \
    xargs grep -l "fortune" 2>/dev/null || true
  register: fortune_profiles
  become: yes
  when: ansible_facts['os_family'] == 'FreeBSD'
  changed_when: false
  ignore_errors: yes

- name: Comment out fortune calls in profile files
  ansible.builtin.replace:
    path: "{{ item }}"
    regexp: '^(\s*)(.*fortune.*)'
    replace: '\1# \2'
  become: yes
  when: 
    - ansible_facts['os_family'] == 'FreeBSD'
    - fortune_profiles.stdout is defined
    - fortune_profiles.stdout | length > 0
  loop: "{{ fortune_profiles.stdout_lines | default([]) }}"
  ignore_errors: yes

- name: Skip MOTD deployment message
  ansible.builtin.debug:
    msg: "Skipping MOTD deployment: user chose to keep existing MOTD."
  when: replace_motd | default('yes') | lower == 'no'

# Configure SSH Banner
# Detect active SSH daemon: dropbear vs OpenSSH (sshd)
# Only relevant on Linux; FreeBSD always uses OpenSSH
- name: Detect active SSH daemon (dropbear vs OpenSSH)
  ansible.builtin.command: pgrep -x dropbear
  become: yes
  register: dropbear_running
  changed_when: false
  failed_when: false
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Set SSH daemon fact
  ansible.builtin.set_fact:
    ssh_daemon: "{{ 'dropbear' if (dropbear_running is defined and dropbear_running.rc == 0) else 'openssh' }}"
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Set SSH daemon fact (non-Linux, default OpenSSH)
  ansible.builtin.set_fact:
    ssh_daemon: openssh
  when: ansible_facts['os_family'] not in ['Debian', 'RedHat']

# Deploy banner file (shared path for both OpenSSH and dropbear)
- name: Ensure /etc/ssh directory exists for banner
  ansible.builtin.file:
    path: /etc/ssh
    state: directory
    mode: '0755'
  become: yes

- name: Deploy SSH banner template
  ansible.builtin.template:
    src: ssh_banner.j2
    dest: /etc/ssh/banner
    owner: root
    group: "{{ root_group }}"
    mode: '0644'
  become: yes
  register: ssh_banner_deployed
  notify: "{{ 'restart dropbear' if ssh_daemon == 'dropbear' else 'restart sshd' }}"

# --- OpenSSH path: sshd_config, syntax check, restart ---
- name: Configure OpenSSH to use banner
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/ssh/banner'
    state: present
  become: yes
  register: ssh_banner_config_updated
  notify: restart sshd
  when: ssh_daemon == 'openssh'

- name: Ensure OpenSSH config syntax is valid
  ansible.builtin.command: sshd -t
  become: yes
  register: sshd_config_test
  changed_when: false
  failed_when: sshd_config_test.rc != 0
  when: ssh_daemon == 'openssh'

# --- Dropbear path: /etc/default/dropbear (Debian) or /etc/sysconfig/dropbear (RHEL) ---
- name: Ensure dropbear config directory exists (RHEL)
  ansible.builtin.file:
    path: /etc/sysconfig
    state: directory
    mode: '0755'
  become: yes
  when:
    - ssh_daemon == 'dropbear'
    - ansible_facts['os_family'] == 'RedHat'

- name: Configure dropbear to use banner (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/default/dropbear
    regexp: '^#?DROPBEAR_EXTRA_ARGS='
    line: 'DROPBEAR_EXTRA_ARGS="-b /etc/ssh/banner"'
    state: present
  become: yes
  register: dropbear_banner_updated
  notify: restart dropbear
  when:
    - ssh_daemon == 'dropbear'
    - ansible_facts['os_family'] == 'Debian'

- name: Configure dropbear to use banner (RHEL)
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/dropbear
    regexp: '^#?OPTIONS='
    line: 'OPTIONS="-b /etc/ssh/banner"'
    state: present
  become: yes
  register: dropbear_banner_updated_rhel
  notify: restart dropbear
  when:
    - ssh_daemon == 'dropbear'
    - ansible_facts['os_family'] == 'RedHat'

