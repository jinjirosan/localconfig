#!/usr/sbin/nft -f
# Ansible managed - security_setup role
# Inbound: established/related, loopback, SSH from allowed subnets, DHCP client. Outbound: established/related, loopback, DNS, DHCP, HTTP/HTTPS/SSH; log and drop rest.

flush ruleset

table inet filter {
    set ssh_allowed {
        type ipv4_addr
        flags interval
        elements = { {{ security_ssh_list | join(', ') }} }
    }

    set dns_servers {
        type ipv4_addr
        elements = { {{ security_dns_list | join(', ') }} }
    }

    chain input {
        type filter hook input priority filter; policy drop;

        ct state established,related accept
        iif lo accept
        ct state invalid drop
        tcp dport 22 ip saddr @ssh_allowed ct state new accept
        udp sport 67 udp dport 68 accept
        counter drop
    }

    chain forward {
        type filter hook forward priority filter; policy drop;
    }

    chain output {
        type filter hook output priority filter; policy drop;

        ct state established,related accept
        oif lo accept
        ip daddr @dns_servers udp dport 53 accept
        ip daddr @dns_servers tcp dport 53 accept
        udp sport 68 udp dport 67 accept
        tcp dport { 80, 443 } accept
        tcp dport 22 accept
        log prefix "nftables-drop-out: " counter drop
    }
}
