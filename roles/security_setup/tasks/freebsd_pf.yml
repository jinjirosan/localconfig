---
# FreeBSD: PF firewall with input/output filtering and logging
# Log prefix for outbound drops: parse "block" in syslog; .bashrc extracts destination IP

- name: Ensure PF is enabled in rc.conf
  ansible.builtin.lineinfile:
    path: /etc/rc.conf
    regexp: '^pf_enable='
    line: 'pf_enable="YES"'
    state: present
  become: yes

- name: Set PF rules file in rc.conf
  ansible.builtin.lineinfile:
    path: /etc/rc.conf
    regexp: '^pf_rules='
    line: 'pf_rules="/etc/pf.conf"'
    state: present
  become: yes

- name: Deploy PF rules file
  ansible.builtin.template:
    src: pf.conf.j2
    dest: /etc/pf.conf
    owner: root
    group: wheel
    mode: '0600'
  become: yes

- name: Test PF rules syntax
  ansible.builtin.command: pfctl -nf /etc/pf.conf
  become: yes
  register: pf_syntax_test
  changed_when: false

- name: Display PF syntax test result
  ansible.builtin.debug:
    msg: "{{ pf_syntax_test.stderr_lines | default([]) }}"
  when: pf_syntax_test.stderr_lines | default([]) | length > 0

- name: Enable PF if not already running
  ansible.builtin.service:
    name: pf
    state: started
    enabled: true
  become: yes

- name: Load PF rules (may temporarily interrupt SSH connection)
  ansible.builtin.shell: "pfctl -f /etc/pf.conf; echo 'PF rules loaded'"
  become: yes
  changed_when: true
  register: pfctl_result
  async: 15
  poll: 3
  # Note: If SSH connection drops due to rule reload, Ansible will reconnect
  # The rules should allow SSH from control host's subnet, so reconnection will work

- name: Verify PF rules loaded successfully
  ansible.builtin.command: pfctl -s rules
  become: yes
  register: pf_rules_check
  changed_when: false
  failed_when: pf_rules_check.rc != 0 or pf_rules_check.stdout | length == 0

# pflogd reads PF log (e.g. "block out log") from pflog interface and writes to /var/log/pflog (binary).
# .bashrc "Top Blocked Destinations" parses that file with tcpdump to show blocked outbound IPs.
- name: Enable pflogd in rc.conf
  ansible.builtin.lineinfile:
    path: /etc/rc.conf
    regexp: '^pflogd_enable='
    line: 'pflogd_enable="YES"'
    state: present
  become: yes

- name: Start and enable pflogd service
  ansible.builtin.service:
    name: pflogd
    state: started
    enabled: true
  become: yes

- name: Ensure newsyslog rotates /var/log/pflog (sends SIGHUP to pflogd)
  ansible.builtin.lineinfile:
    path: /etc/newsyslog.conf
    regexp: '^/var/log/pflog\s'
    line: '/var/log/pflog  root:wheel  644  7  *  @T00  GBJC  /var/run/pflogd.pid'
    state: present
  become: yes
  ignore_errors: yes  # Format may vary across FreeBSD versions

- name: Check if syslog.conf exists
  ansible.builtin.stat:
    path: /etc/syslog.conf
  register: syslog_conf

- name: Ensure PF logs go to /var/log/messages (if syslog.conf exists)
  ansible.builtin.lineinfile:
    path: /etc/syslog.conf
    regexp: '^local0\.\*'
    line: 'local0.*		/var/log/messages'
    state: present
  become: yes
  when: syslog_conf.stat.exists
  ignore_errors: yes  # May already be configured or use different format

- name: Reload syslogd if syslog.conf was modified
  ansible.builtin.command: killall -HUP syslogd
  become: yes
  when: syslog_conf.stat.exists
  ignore_errors: yes  # May fail if syslogd not running or no permission
