
---
# Tools Setup Role

# OS Detection and Package Manager Setup
- name: Detect if system is Debian/Ubuntu
  ansible.builtin.set_fact:
    pkg_manager: "apt"
  when: ansible_facts['os_family'] == "Debian"

- name: Detect if system is FreeBSD
  ansible.builtin.set_fact:
    pkg_manager: "pkg"
  when: ansible_facts['os_family'] == "FreeBSD"

- name: Detect if system is RHEL-based
  ansible.builtin.stat:
    path: /etc/redhat-release
  register: rhel_release_check
  when: ansible_facts['os_family'] != "Debian" and ansible_facts['os_family'] != "FreeBSD"

- name: Set pkg_manager to yum/dnf for RHEL
  ansible.builtin.set_fact:
    pkg_manager: "yum"
  when: 
    - rhel_release_check.stat.exists is defined
    - rhel_release_check.stat.exists

# Set sudoers file path based on OS
- name: Set sudoers path for FreeBSD
  ansible.builtin.set_fact:
    sudoers_path: "/usr/local/etc/sudoers"
  when: ansible_facts['os_family'] == "FreeBSD"

- name: Set sudoers path for Linux (Debian/Ubuntu/RHEL)
  ansible.builtin.set_fact:
    sudoers_path: "/etc/sudoers"
  when: ansible_facts['os_family'] != "FreeBSD"

# Install Sudo if Missing (Debian/Ubuntu)
- name: Ensure sudo is installed on Debian/Ubuntu
  ansible.builtin.package:
    name: sudo
    state: present
  when: pkg_manager == "apt"
  become: yes

# Check if ansible_user is already in sudoers
- name: Check if ansible_user is already in sudoers
  ansible.builtin.shell: grep -Fxq "{{ ansible_user }} ALL=(ALL:ALL) NOPASSWD:ALL" {{ sudoers_path }}
  register: sudoers_check
  become: yes
  failed_when: sudoers_check.rc not in [0, 1]
  changed_when: sudoers_check.rc == 1

# Add ansible_user to sudoers with NOPASSWD
- name: Add ansible_user to sudoers with NOPASSWD
  ansible.builtin.shell: |
    echo "{{ ansible_user }} ALL=(ALL:ALL) NOPASSWD:ALL" | sudo EDITOR='tee -a' visudo
  become: yes
  become_user: root
  when: sudoers_check.rc == 1

# Switch back to ansible_user
- name: Continue tasks as ansible_user
  ansible.builtin.command: whoami
  become: yes
  become_user: "{{ ansible_user }}"

# Install Essential Tools (Debian/Ubuntu)
- name: Install essential tools for Debian/Ubuntu
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  when: pkg_manager == "apt"
  become: yes
  loop: "{{ debian_ubuntu_packages }}"
  ignore_errors: yes
  register: debian_package_results

- name: Report any failed package installations (Debian/Ubuntu)
  ansible.builtin.debug:
    msg: "Warning: Package '{{ item.item }}' is not available and was skipped"
  when: 
    - pkg_manager == "apt"
    - item is failed
  loop: "{{ debian_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

# Install Essential Tools (FreeBSD)
- name: Install essential tools for FreeBSD
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  when: pkg_manager == "pkg"
  become: yes
  loop: "{{ freebsd_packages }}"
  ignore_errors: yes
  register: freebsd_package_results

- name: Report any failed package installations (FreeBSD)
  ansible.builtin.debug:
    msg: "Warning: Package '{{ item.item }}' is not available and was skipped"
  when: 
    - pkg_manager == "pkg"
    - item is failed
  loop: "{{ freebsd_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

# Install Essential Tools (RHEL)
- name: Install essential tools for RHEL
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  when: pkg_manager == "yum"
  become: yes
  loop: "{{ rhel_packages }}"
  ignore_errors: yes
  register: rhel_package_results

- name: Report any failed package installations (RHEL)
  ansible.builtin.debug:
    msg: "Warning: Package '{{ item.item }}' is not available and was skipped"
  when: 
    - pkg_manager == "yum"
    - item is failed
  loop: "{{ rhel_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

# Check Installed Package Status (Debian/Ubuntu)
- name: Check package status on Debian/Ubuntu
  ansible.builtin.command: dpkg -l {{ item }}
  register: package_check
  changed_when: false
  failed_when: false
  loop: "{{ debian_ubuntu_packages }}"
  when: pkg_manager == "apt"

# Check Installed Package Status (FreeBSD)
- name: Check package status on FreeBSD
  ansible.builtin.command: pkg info {{ item }}
  register: package_check_freebsd
  changed_when: false
  failed_when: false
  loop: "{{ freebsd_packages }}"
  when: pkg_manager == "pkg"

# Check Installed Package Status (RHEL)
- name: Check package status on RHEL
  ansible.builtin.command: dnf list installed {{ item }}
  register: package_check_rhel
  changed_when: false
  failed_when: false
  loop: "{{ rhel_packages }}"
  when: pkg_manager == "yum"

# Configure Locales (Debian/Ubuntu)
- name: Install locales package (Debian/Ubuntu)
  ansible.builtin.package:
    name: locales
    state: present
  when: pkg_manager == "apt"
  become: yes

- name: Check if locale.gen exists (Debian/Ubuntu)
  ansible.builtin.stat:
    path: /etc/locale.gen
  register: locale_gen_file
  when: pkg_manager == "apt"
  become: yes

- name: Uncomment en_US.UTF-8 in locale.gen (Debian/Ubuntu)
  ansible.builtin.replace:
    path: /etc/locale.gen
    regexp: '^#\s*(en_US\.UTF-8\s+UTF-8)'
    replace: '\1'
  when: 
    - pkg_manager == "apt"
    - locale_gen_file.stat.exists
  become: yes
  register: locale_gen_modified

- name: Verify locale.gen was modified (Debian/Ubuntu)
  ansible.builtin.debug:
    msg: "Locale.gen modification status: {{ locale_gen_modified.changed }}"
  when: 
    - pkg_manager == "apt"
    - locale_gen_file.stat.exists

- name: Check if UTF-8 locale is already generated (Debian/Ubuntu)
  ansible.builtin.command: locale -a
  register: available_locales
  when: pkg_manager == "apt"
  become: yes
  changed_when: false
  failed_when: false

- name: Generate UTF-8 locales (Debian/Ubuntu)
  ansible.builtin.command: locale-gen
  when: 
    - pkg_manager == "apt"
    - locale_gen_file.stat.exists
    - "'en_US.UTF-8' not in available_locales.stdout and 'en_US.utf8' not in available_locales.stdout"
  become: yes
  register: locale_gen_result

- name: Verify locale was generated (Debian/Ubuntu)
  ansible.builtin.command: locale -a | grep -E "(en_US\.UTF-8|en_US\.utf8)"
  register: locale_verify
  when: 
    - pkg_manager == "apt"
    - locale_gen_result is defined
  become: yes
  changed_when: false
  failed_when: false

- name: Warn if locale generation failed (Debian/Ubuntu)
  ansible.builtin.debug:
    msg: "Warning: en_US.UTF-8 locale may not be available. Locale generation may have failed."
  when: 
    - pkg_manager == "apt"
    - locale_verify.rc != 0
    - locale_gen_result is defined

- name: Update default locale (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    regexp: '^LANG='
    line: 'LANG=en_US.UTF-8'
    state: present
    create: yes
  when: pkg_manager == "apt"
  become: yes

- name: Remove invalid locale settings from /etc/default/locale (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    regexp: '^LC_(CTYPE|COLLATE|MESSAGES|MONETARY|NUMERIC|TIME)=(UTF-8|utf-8)$'
    state: absent
  when: pkg_manager == "apt"
  become: yes

- name: Remove any other invalid locale patterns from /etc/default/locale (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    regexp: '^LC_CTYPE=.*[^A-Za-z0-9_.-]UTF-8$'
    state: absent
  when: pkg_manager == "apt"
  become: yes

- name: Set proper LC_* variables in /etc/default/locale (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    line: "{{ item }}"
    state: present
    create: yes
  when: pkg_manager == "apt"
  become: yes
  loop:
    - "LC_ALL=en_US.UTF-8"
    - "LC_CTYPE=en_US.UTF-8"
    - "LC_COLLATE=en_US.UTF-8"

- name: Set locale in /etc/environment as safety net (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^LC_CTYPE='
    line: 'LC_CTYPE=en_US.UTF-8'
    state: present
    create: yes
  when: pkg_manager == "apt"
  become: yes

- name: Set LANG in /etc/environment as safety net (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^LANG='
    line: 'LANG=en_US.UTF-8'
    state: present
    create: yes
  when: pkg_manager == "apt"
  become: yes

- name: Set LC_ALL in /etc/environment as safety net (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^LC_ALL='
    line: 'LC_ALL=en_US.UTF-8'
    state: present
    create: yes
  when: pkg_manager == "apt"
  become: yes

# Configure Locales (RHEL)
- name: Install glibc-langpack (RHEL)
  ansible.builtin.package:
    name: glibc-langpack-en
    state: present
  when: pkg_manager == "yum"
  become: yes
  ignore_errors: yes

- name: Set locale in locale.conf (RHEL)
  ansible.builtin.lineinfile:
    path: /etc/locale.conf
    regexp: '^LANG='
    line: 'LANG=en_US.UTF-8'
    state: present
    create: yes
  when: pkg_manager == "yum"
  become: yes

# Configure Locales (FreeBSD)
# Note: FreeBSD typically has UTF-8 locales available by default
# We'll set environment variables in profile files instead of modifying login.conf
# to avoid breaking the system configuration
- name: Set locale in /etc/profile (FreeBSD)
  ansible.builtin.lineinfile:
    path: /etc/profile
    regexp: '^export LANG='
    line: 'export LANG=en_US.UTF-8'
    state: present
    insertafter: EOF
  when: pkg_manager == "pkg"
  become: yes
  ignore_errors: yes

# Collect failed packages for summary
- name: Collect failed packages (Debian/Ubuntu)
  ansible.builtin.set_fact:
    failed_packages: "{{ failed_packages | default([]) + [item.item] }}"
  when: 
    - pkg_manager == "apt"
    - item is failed
  loop: "{{ debian_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

- name: Collect failed packages (FreeBSD)
  ansible.builtin.set_fact:
    failed_packages: "{{ failed_packages | default([]) + [item.item] }}"
  when: 
    - pkg_manager == "pkg"
    - item is failed
  loop: "{{ freebsd_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

- name: Collect failed packages (RHEL)
  ansible.builtin.set_fact:
    failed_packages: "{{ failed_packages | default([]) + [item.item] }}"
  when: 
    - pkg_manager == "yum"
    - item is failed
  loop: "{{ rhel_package_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"

# Debugging and Status Reporting
- name: Display package statuses (Debian/Ubuntu)
  ansible.builtin.debug:
    var: package_check.results
  when: pkg_manager == "apt"

- name: Display package statuses (FreeBSD)
  ansible.builtin.debug:
    var: package_check_freebsd.results
  when: pkg_manager == "pkg"

- name: Display package statuses (RHEL)
  ansible.builtin.debug:
    var: package_check_rhel
  when: pkg_manager == "yum"
