
---
# Vim Configuration Setup

# Detect Vim Version Dynamically
- name: Detect Vim version
  ansible.builtin.shell: "vim --version | head -n 1 | awk '{print $5}'"
  register: vim_version_result
  changed_when: false

- name: Set Vim version fact
  ansible.builtin.set_fact:
    vim_version: "{{ vim_version_result.stdout | regex_replace('\\.', '') }}"

# Detect Vim base directory (FreeBSD uses /usr/local/share/vim, others use /usr/share/vim)
- name: Set Vim base directory
  ansible.builtin.set_fact:
    vim_base_dir: "/usr/local/share/vim"
  when: ansible_facts['os_family'] == 'FreeBSD'

- name: Set Vim base directory for non-FreeBSD
  ansible.builtin.set_fact:
    vim_base_dir: "/usr/share/vim"
  when: ansible_facts['os_family'] != 'FreeBSD'

# Copy Configuration Files to Ansible User's Home Directory
- name: Copy configuration files to ansible user's home directory
  ansible.builtin.copy:
    src: "{{ files_dir }}/{{ item }}"
    dest: "~{{ ansible_user }}/{{ item }}"
  loop:
    - .vimrc
    - .screenrc
    - .bashrc
    - .bash_profile
    - .curlrc
    - quick_ref_keybindings.txt

# Get bash path for shell changes
- name: Get bash path
  ansible.builtin.command: command -v bash
  register: bash_path
  changed_when: false
  failed_when: false

# Change ansible_user shell to bash if available
- name: Change ansible_user shell to bash if available
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    shell: "{{ bash_path.stdout }}"
  become: yes
  when: bash_path.rc == 0 and bash_path.stdout is defined and bash_path.stdout | length > 0

- name: Ensure .vim directory exists in ansible user's home
  ansible.builtin.file:
    path: "~{{ ansible_user }}/.vim"
    state: directory

- name: Ensure screen directories exist in ansible user's home
  ansible.builtin.file:
    path: "~{{ ansible_user }}/screen/{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    mode: '0755'
  loop:
    - hardcopy
    - log

# Handle "all" users case
- name: Get all users with home directories
  ansible.builtin.shell: |
    getent passwd | awk -F: '$3 >= 1000 && $3 < 65534 && $6 ~ /^\/home\// {print $1":"$6}'
  register: all_users_with_homes
  changed_when: false
  when: target_user is defined and target_user == "all"
  become: yes

- name: Set fact for all users list
  ansible.builtin.set_fact:
    users_to_configure: "{{ all_users_with_homes.stdout_lines | map('regex_replace', '(.*):(.*)', '\\1') | list }}"
  when: target_user is defined and target_user == "all"

- name: Get all user home directories
  ansible.builtin.set_fact:
    user_homes: "{{ user_homes | default({}) | combine({item.split(':')[0]: item.split(':')[1]}) }}"
  loop: "{{ all_users_with_homes.stdout_lines }}"
  when: target_user is defined and target_user == "all"

# Convert target_user to list if it contains spaces (multiple users)
- name: Set target_users_list fact
  ansible.builtin.set_fact:
    target_users_list: "{{ (target_user is defined and target_user != ansible_user and target_user != 'all' and ' ' in target_user) | ternary(target_user.split(' '), (target_user is defined and target_user != ansible_user and target_user != 'all') | ternary([target_user], [])) }}"
  when: target_user is defined and target_user != ansible_user and target_user != "all"

# Get home directories for all target users
- name: Get target users' home directories
  ansible.builtin.shell: "getent passwd {{ item }} | cut -d: -f6"
  register: target_user_homes
  changed_when: false
  loop: "{{ target_users_list }}"
  when: target_user is defined and target_user != ansible_user and target_user != "all" and target_users_list | length > 0
  become: yes
  loop_control:
    label: "{{ item }}"

# Ensure screen directories exist in target users' homes
- name: Ensure screen directories exist in target users' homes
  ansible.builtin.file:
    path: "{{ item.1.stdout }}/screen/{{ item.0 }}"
    state: directory
    owner: "{{ item.1.item }}"
    mode: '0755'
  loop: "{{ ['hardcopy', 'log'] | product(target_user_homes.results) | list }}"
  when:
    - target_user is defined
    - target_user != ansible_user
    - target_user != "all"
    - target_users_list | length > 0
    - item.1.stdout is defined
  become: yes
  loop_control:
    label: "{{ item.1.item }}: screen/{{ item.0 }}"

# Copy Configuration Files to Target Users' Home Directories
- name: Copy configuration files to target users' home directories
  ansible.builtin.copy:
    src: "{{ files_dir }}/{{ item.0 }}"
    dest: "{{ item.1.stdout }}/{{ item.0 }}"
    owner: "{{ item.1.item }}"
    mode: '0644'
  loop: "{{ ['.vimrc', '.screenrc', '.bashrc', '.bash_profile', '.curlrc', 'quick_ref_keybindings.txt'] | product(target_user_homes.results) | list }}"
  when: 
    - target_user is defined 
    - target_user != ansible_user 
    - target_user != "all"
    - target_users_list | length > 0
    - item.1.stdout is defined
  become: yes
  loop_control:
    label: "{{ item.1.item }}: {{ item.0 }}"

# Change target users' shells to bash if available
- name: Change target users' shells to bash if available
  ansible.builtin.user:
    name: "{{ item.item }}"
    shell: "{{ bash_path.stdout }}"
  become: yes
  when: 
    - target_user is defined 
    - target_user != ansible_user 
    - target_user != "all"
    - target_users_list | length > 0
    - bash_path.rc == 0
    - bash_path.stdout is defined
    - bash_path.stdout | length > 0
  loop: "{{ target_user_homes.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Ensure .vim directory exists in target users' homes
  ansible.builtin.file:
    path: "{{ item.stdout }}/.vim"
    state: directory
    owner: "{{ item.item }}"
    mode: '0755'
  loop: "{{ target_user_homes.results }}"
  when: 
    - target_user is defined 
    - target_user != ansible_user 
    - target_user != "all"
    - target_users_list | length > 0
    - item.stdout is defined
  become: yes
  loop_control:
    label: "{{ item.item }}"

# Configure all users (when target_user is "all")
- name: Copy .vimrc to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/.vimrc"
    dest: "{{ user_homes[item] }}/.vimrc"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Copy .screenrc to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/.screenrc"
    dest: "{{ user_homes[item] }}/.screenrc"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Copy .bashrc to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/.bashrc"
    dest: "{{ user_homes[item] }}/.bashrc"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Copy .bash_profile to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/.bash_profile"
    dest: "{{ user_homes[item] }}/.bash_profile"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

# Change all users' shells to bash if available
- name: Change all users' shells to bash if available
  ansible.builtin.user:
    name: "{{ item }}"
    shell: "{{ bash_path.stdout }}"
  become: yes
  when: 
    - target_user is defined 
    - target_user == "all"
    - users_to_configure is defined
    - bash_path.rc == 0
    - bash_path.stdout is defined
    - bash_path.stdout | length > 0
  loop: "{{ users_to_configure }}"

- name: Copy .curlrc to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/.curlrc"
    dest: "{{ user_homes[item] }}/.curlrc"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Copy quick_ref_keybindings.txt to all users
  ansible.builtin.copy:
    src: "{{ files_dir }}/quick_ref_keybindings.txt"
    dest: "{{ user_homes[item] }}/quick_ref_keybindings.txt"
    owner: "{{ item }}"
    mode: '0644'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Ensure .vim directory exists in all users' homes
  ansible.builtin.file:
    path: "{{ user_homes[item] }}/.vim"
    state: directory
    owner: "{{ item }}"
    mode: '0755'
  loop: "{{ users_to_configure }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes

- name: Ensure screen directories exist in all users' homes
  ansible.builtin.file:
    path: "{{ user_homes[item.0] }}/screen/{{ item.1 }}"
    state: directory
    owner: "{{ item.0 }}"
    mode: '0755'
  loop: "{{ users_to_configure | product(['hardcopy', 'log']) | list }}"
  when: target_user is defined and target_user == "all" and users_to_configure is defined
  become: yes
  loop_control:
    label: "{{ item.0 }}: screen/{{ item.1 }}"

# Copy Configuration Files to Root's Home Directory
- name: Copy configuration files to root's home directory
  ansible.builtin.copy:
    src: "{{ files_dir }}/{{ item }}"
    dest: "/root/{{ item }}"
  loop:
    - .vimrc
    - .screenrc
    - .bashrc
    - .bash_profile
    - .curlrc
    - quick_ref_keybindings.txt
  become: yes

# Change root shell to bash if available
- name: Change root shell to bash if available
  ansible.builtin.user:
    name: root
    shell: "{{ bash_path.stdout }}"
  become: yes
  when: bash_path.rc == 0 and bash_path.stdout is defined and bash_path.stdout | length > 0

- name: Ensure .vim directory exists in root's home
  ansible.builtin.file:
    path: "/root/.vim"
    state: directory
  become: yes

- name: Ensure screen directories exist in root's home
  ansible.builtin.file:
    path: "/root/screen/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - hardcopy
    - log
  become: yes

# Configure Vim Colors, Plugins, and Autoload
- name: Ensure Vim colors directory exists
  ansible.builtin.file:
    path: "{{ vim_base_dir }}/vim{{ vim_version }}/colors"
    state: directory
  become: yes

- name: Copy badwolf.vim color theme to Vim colors directory
  ansible.builtin.copy:
    src: "{{ files_dir }}/colors/badwolf.vim"
    dest: "{{ vim_base_dir }}/vim{{ vim_version }}/colors/badwolf.vim"
  become: yes

- name: Ensure Vim plugin directory exists
  ansible.builtin.file:
    path: "{{ vim_base_dir }}/vim{{ vim_version }}/plugin"
    state: directory
  become: yes

- name: Copy Vim plugin files
  ansible.builtin.copy:
    src: "{{ files_dir }}/plugin/{{ item }}"
    dest: "{{ vim_base_dir }}/vim{{ vim_version }}/plugin/{{ item }}"
  loop:
    - airline.vim
    - airline-themes.vim
  become: yes

- name: Ensure Vim autoload directory exists
  ansible.builtin.file:
    path: "{{ vim_base_dir }}/vim{{ vim_version }}/autoload"
    state: directory
  become: yes

- name: Copy autoload tree to Vim autoload directory
  ansible.builtin.copy:
    src: "{{ files_dir }}/autoload/"
    dest: "{{ vim_base_dir }}/vim{{ vim_version }}/autoload/"
    mode: preserve
  become: yes
