
---
- name: Initial Setup
  hosts: all
  gather_facts: yes
  # Use ansible_user from inventory - don't override connection user
  vars:
    target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
    # Convert target_user to list if it contains spaces (multiple users)
    target_users_list: "{{ (target_user is defined and target_user != 'all' and ' ' in target_user) | ternary(target_user.split(' '), (target_user is defined and target_user != 'all') | ternary([target_user], [])) }}"
    # Convert additional_sudo_users to list if provided (space-separated)
    additional_sudo_users_list: "{{ (additional_sudo_users is defined and additional_sudo_users != '' and ' ' in additional_sudo_users) | ternary(additional_sudo_users.split(' '), (additional_sudo_users is defined and additional_sudo_users != '') | ternary([additional_sudo_users], [])) }}"
  tasks:
    - name: Set sudoers path based on OS
      ansible.builtin.set_fact:
        sudoers_path: "{{ '/usr/local/etc/sudoers' if ansible_facts['os_family'] == 'FreeBSD' else '/etc/sudoers' }}"

    - name: Check if target_user(s) are in sudoers
      ansible.builtin.shell: grep -q "{{ item }} ALL=(ALL:ALL) NOPASSWD:ALL" {{ sudoers_path }}
      register: sudoers_check
      failed_when: sudoers_check.rc not in [0, 1]
      become: true
      loop: "{{ target_users_list }}"
      when: target_user is defined and target_user != "all" and target_users_list | length > 0
      loop_control:
        label: "{{ item }}"

    - name: Add target_user(s) to sudoers
      ansible.builtin.shell: |
        echo "{{ item.item }} ALL=(ALL:ALL) NOPASSWD:ALL" >> {{ sudoers_path }}
      become: true
      loop: "{{ sudoers_check.results | default([]) }}"
      when: 
        - target_user is defined 
        - target_user != "all"
        - target_users_list | length > 0
        - item.rc == 1
      loop_control:
        label: "{{ item.item }}"

    - name: Check if additional_sudo_users are in sudoers
      ansible.builtin.shell: grep -q "{{ item }} ALL=(ALL:ALL) NOPASSWD:ALL" {{ sudoers_path }}
      register: additional_sudoers_check
      failed_when: additional_sudoers_check.rc not in [0, 1]
      become: true
      loop: "{{ additional_sudo_users_list }}"
      when: additional_sudo_users_list is defined and additional_sudo_users_list | length > 0
      loop_control:
        label: "{{ item }}"

    - name: Add additional_sudo_users to sudoers
      ansible.builtin.shell: |
        echo "{{ item.item }} ALL=(ALL:ALL) NOPASSWD:ALL" >> {{ sudoers_path }}
      become: true
      loop: "{{ additional_sudoers_check.results | default([]) }}"
      when: 
        - additional_sudo_users_list is defined
        - additional_sudo_users_list | length > 0
        - item.rc == 1
      loop_control:
        label: "{{ item.item }}"

- name: Setup All Systems
  hosts: all
  gather_facts: yes
  vars:
    files_dir: "{{ playbook_dir }}/../files"
    target_user: "{{ target_user | default(ansible_user) }}"
  roles:
    - ssh_setup
    - tools_setup
    - vim_config
    - login_setup

- name: Installation Summary
  hosts: all
  gather_facts: no
  tasks:
    - name: Set summary variables
      ansible.builtin.set_fact:
        summary_failed_packages: "{{ hostvars[inventory_hostname]['failed_packages'] | default([]) }}"
        summary_os: "{{ hostvars[inventory_hostname]['ansible_distribution'] | default('Unknown') }}"
        summary_os_version: "{{ hostvars[inventory_hostname]['ansible_distribution_version'] | default('') }}"
    
    - name: Display installation summary
      ansible.builtin.debug:
        msg: |
          
          ========================================
          Installation Summary
          ========================================
          
          Host: {{ inventory_hostname }}
          OS: {{ summary_os }} {{ summary_os_version }}
          
          {% if summary_failed_packages | length > 0 %}
          ⚠️  Packages that could not be installed:
          {% for pkg in summary_failed_packages %}
            - {{ pkg }}
          {% endfor %}
          
          These packages are not available in your system's repositories.
          You may need to:
          1. Check if alternative package names exist
          2. Add additional repositories
          3. Install manually if needed
          {% else %}
          ✅ All packages installed successfully!
          {% endif %}
          
          ========================================

