
---
- name: Initial Setup
  hosts: all
  # Use ansible_user from inventory - don't override connection user
  vars:
    target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
  tasks:
    - name: Check if target_user is in sudoers
      ansible.builtin.shell: grep -q "{{ target_user }} ALL=(ALL:ALL) NOPASSWD:ALL" /etc/sudoers
      register: sudoers_check
      failed_when: sudoers_check.rc not in [0, 1]
      become: true

    - name: Add target_user to sudoers
      ansible.builtin.shell: |
        echo "{{ target_user }} ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers
      become: true
      when: sudoers_check.rc == 1

- name: Setup All Systems
  hosts: all
  gather_facts: yes
  vars:
    files_dir: "{{ playbook_dir }}/../files"
    target_user: "{{ target_user | default(ansible_user) }}"
  roles:
    - ssh_setup
    - tools_setup
    - vim_config

