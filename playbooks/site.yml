
---
- name: Initial Setup
  hosts: all
  gather_facts: yes
  # Use ansible_user from inventory - don't override connection user
  vars:
    target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
    # Convert target_user to list if it contains spaces (multiple users)
    target_users_list: "{{ (target_user is defined and target_user != 'all' and ' ' in target_user) | ternary(target_user.split(' '), (target_user is defined and target_user != 'all') | ternary([target_user], [])) }}"
    # Convert additional_sudo_users to list if provided (space-separated)
    additional_sudo_users_list: "{{ (additional_sudo_users is defined and additional_sudo_users != '' and ' ' in additional_sudo_users) | ternary(additional_sudo_users.split(' '), (additional_sudo_users is defined and additional_sudo_users != '') | ternary([additional_sudo_users], [])) }}"
  tasks:
    - name: Set sudoers path based on OS
      ansible.builtin.set_fact:
        sudoers_path: "{{ '/usr/local/etc/sudoers' if ansible_facts['os_family'] == 'FreeBSD' else '/etc/sudoers' }}"

    - name: Check if target_user(s) are in sudoers
      ansible.builtin.shell: grep -q "{{ item }} ALL=(ALL:ALL) NOPASSWD:ALL" {{ sudoers_path }}
      register: sudoers_check
      failed_when: sudoers_check.rc not in [0, 1]
      become: true
      loop: "{{ target_users_list }}"
      when: target_user is defined and target_user != "all" and target_users_list | length > 0
      loop_control:
        label: "{{ item }}"

    - name: Add target_user(s) to sudoers
      ansible.builtin.shell: |
        echo "{{ item.item }} ALL=(ALL:ALL) NOPASSWD:ALL" >> {{ sudoers_path }}
      become: true
      loop: "{{ sudoers_check.results | default([]) }}"
      when: 
        - target_user is defined 
        - target_user != "all"
        - target_users_list | length > 0
        - item.rc == 1
      loop_control:
        label: "{{ item.item }}"

    - name: Check if additional_sudo_users are in sudoers
      ansible.builtin.shell: grep -q "{{ item }} ALL=(ALL:ALL) NOPASSWD:ALL" {{ sudoers_path }}
      register: additional_sudoers_check
      failed_when: additional_sudoers_check.rc not in [0, 1]
      become: true
      loop: "{{ additional_sudo_users_list }}"
      when: additional_sudo_users_list is defined and additional_sudo_users_list | length > 0
      loop_control:
        label: "{{ item }}"

    - name: Add additional_sudo_users to sudoers
      ansible.builtin.shell: |
        echo "{{ item.item }} ALL=(ALL:ALL) NOPASSWD:ALL" >> {{ sudoers_path }}
      become: true
      loop: "{{ additional_sudoers_check.results | default([]) }}"
      when: 
        - additional_sudo_users_list is defined
        - additional_sudo_users_list | length > 0
        - item.rc == 1
      loop_control:
        label: "{{ item.item }}"

- name: Setup All Systems
  hosts: all
  gather_facts: yes
  vars:
    files_dir: "{{ playbook_dir }}/../files"
    target_user: "{{ target_user | default(ansible_user) }}"
  roles:
    - ssh_setup
    - tools_setup
    - vim_config
    - login_setup
    - role: security_setup
      when: security_setup_enabled | default(false) | bool
    - role: desktop_apps_setup
      when: desktop_apps_enabled | default(false) | bool

- name: Installation Summary
  hosts: all
  gather_facts: no
  tasks:
    - name: Set summary variables
      ansible.builtin.set_fact:
        summary_failed_packages: "{{ hostvars[inventory_hostname]['failed_packages'] | default([]) }}"
        summary_os: "{{ hostvars[inventory_hostname]['ansible_distribution'] | default('Unknown') }}"
        summary_os_version: "{{ hostvars[inventory_hostname]['ansible_distribution_version'] | default('') }}"
    
    - name: Display installation summary
      ansible.builtin.debug:
        msg: |
          
          ========================================
          Installation Summary
          ========================================
          
          Host: {{ inventory_hostname }}
          OS: {{ summary_os }} {{ summary_os_version }}
          
          {% if summary_failed_packages | length > 0 %}
          ⚠️  Packages that could not be installed:
          {% for pkg in summary_failed_packages %}
            - {{ pkg }}
          {% endfor %}
          
          These packages are not available in your system's repositories.
          You may need to:
          1. Check if alternative package names exist
          2. Add additional repositories
          3. Install manually if needed
          {% else %}
          ✅ All packages installed successfully!
          {% endif %}
          
          ========================================

- name: Disable ansible user (remote only, after install complete)
  hosts: all
  gather_facts: yes
  tasks:
    - name: Set sudoers path for disable step
      ansible.builtin.set_fact:
        sudoers_path: "{{ '/usr/local/etc/sudoers' if ansible_facts['os_family'] == 'FreeBSD' else '/etc/sudoers' }}"
      when: ansible_connection != 'local'

    - name: Get ansible user home directory
      ansible.builtin.shell: |
        getent passwd "{{ ansible_user }}" | cut -d: -f6
      register: ansible_user_home_cmd
      changed_when: false
      when: ansible_connection != 'local'

    - name: Schedule delayed disable of ansible user (SSH key + sudo)
      ansible.builtin.shell: |
        set -eu
        ANSIBLE_USER="{{ ansible_user }}"
        SUDOERS_FILE="{{ sudoers_path }}"
        ANSIBLE_HOME="{{ ansible_user_home_cmd.stdout | default('') }}"

        (
          # Small delay to ensure Ansible play finishes cleanly before we revoke access
          sleep 30

          # Disable SSH key login for ansible user
          if [ -n "$ANSIBLE_HOME" ] && [ -f "$ANSIBLE_HOME/.ssh/authorized_keys" ]; then
            mv "$ANSIBLE_HOME/.ssh/authorized_keys" "$ANSIBLE_HOME/.ssh/authorized_keys.disabled" 2>/dev/null || true
          fi

          # Remove ansible user from sudoers (portable sed -i syntax)
          if [ -n "$ANSIBLE_USER" ] && [ -f "$SUDOERS_FILE" ]; then
            # FreeBSD/BSD sed: -i.bak, GNU sed also accepts this form
            sed -i.bak "/^${ANSIBLE_USER} ALL=(ALL:ALL) NOPASSWD:ALL$/d" "$SUDOERS_FILE" 2>/dev/null || true
          fi
        ) >/var/log/ansible_disable_ansible_user.log 2>&1 &
      become: true
      when:
        - ansible_connection != 'local'
        - ansible_user_home_cmd.stdout is defined
        - ansible_user_home_cmd.stdout != ''

    - name: Display ansible user disable scheduled message
      ansible.builtin.debug:
        msg: "Ansible user '{{ ansible_user }}' disable has been scheduled (SSH keys and sudo will be revoked shortly after play completion). Run setup_client.sh on this host as root to re-enable for future Ansible runs."
      when: ansible_connection != 'local'

