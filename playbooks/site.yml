
---
- name: Initial Setup
  hosts: all
  # Use ansible_user from inventory - don't override connection user
  vars:
    target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
    # Convert target_user to list if it contains spaces (multiple users)
    target_users_list: "{{ (target_user is defined and target_user != 'all' and ' ' in target_user) | ternary(target_user.split(' '), (target_user is defined and target_user != 'all') | ternary([target_user], [])) }}"
  tasks:
    - name: Check if target_user(s) are in sudoers
      ansible.builtin.shell: grep -q "{{ item }} ALL=(ALL:ALL) NOPASSWD:ALL" /etc/sudoers
      register: sudoers_check
      failed_when: sudoers_check.rc not in [0, 1]
      become: true
      loop: "{{ target_users_list }}"
      when: target_user is defined and target_user != "all" and target_users_list | length > 0
      loop_control:
        label: "{{ item }}"

    - name: Add target_user(s) to sudoers
      ansible.builtin.shell: |
        echo "{{ item.item }} ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers
      become: true
      loop: "{{ sudoers_check.results | default([]) }}"
      when: 
        - target_user is defined 
        - target_user != "all"
        - target_users_list | length > 0
        - item.rc == 1
      loop_control:
        label: "{{ item.item }}"

- name: Setup All Systems
  hosts: all
  gather_facts: yes
  vars:
    files_dir: "{{ playbook_dir }}/../files"
    target_user: "{{ target_user | default(ansible_user) }}"
  roles:
    - ssh_setup
    - tools_setup
    - vim_config

