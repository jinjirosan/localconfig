# localconfig 4.0

The original localconfig repo contained the configuration files, tools and settings to get my own user environment onto a system. You know, so I feel at home :-)
This was a manual copy of files like .bashrc , .screenrc and .vimrc 
The problem is the manual part, need to figure out which directory vim is in (each version is using a different one such as vim74/ or vim81). Also the prerequisites need to be met, manually installing the tools like screen, vim and dependencies. Also user management (sudo) and SSH keys.

Well, no more I say :)

Everything is now in an Ansible Playbook with roles and the target systems can be Debian, Ubunutu or RHEL. It'll automatically detect and use the correct package manager and syntax.

Package version: 4.0 (2024/12 update)

## Quick Start

### For Local Machine Setup:
```bash
git clone <repo-url>
cd localconfig
./setup_local.sh
```

### For Remote VM Setup:
1. **On the new VM:** Copy `setup_client.sh` and run it to prepare the VM
2. **On the control host:** Run `setup_remote.sh <vm_ip>` to deploy localconfig

See detailed instructions below.

## Instructions
Two items are not included in the git which need to be added:
- hosts.ini file (auto-generated by setup scripts)
- discovered_ssh_keys directory (auto-generated by ssh_setup role)

### Main Playbook: `site.yml`

The playbook orchestrates several roles that set up your development environment:

1. **ssh_setup**: 
   - Ensures SSH key pair exists on control machine
   - Installs `sshpass` (Debian/Ubuntu) for password-based setup
   - Copies public key to target systems' `authorized_keys`
   - Backs up all SSH keys from target systems to `discovered_ssh_keys/` directory

2. **tools_setup**:
   - Detects OS (Debian/Ubuntu vs RHEL vs FreeBSD) and selects appropriate package manager
   - Installs essential tools: `sudo`, `vim`, `htop`, `screen`, `net-tools`, `git`, `cifs-utils`, `gnupg`, `curl`, `gcc`, `mlocate` (Linux) or `findutils` (FreeBSD)
   - Configures sudo access with NOPASSWD for the ansible user
   - Verifies package installation

3. **vim_config**:
   - Detects Vim version dynamically
   - Deploys dotfiles (`.vimrc`, `.bashrc`, `.screenrc`, `.curlrc`) to user home directories
   - Installs Badwolf color scheme and vim-airline plugin
   - Deploys all Vim autoload scripts and plugins
   - Configures system-wide Vim directories

4. **login_setup**:
   - Configures MOTD (Message of the Day) with ASCII art hostname banner
   - Sets up SSH login banners with security warning
   - Dynamic System Information (hostname, OS, kernel, IP addresses with reverse DNS) displayed in `.bashrc` on login
   - OS-aware deployment (Debian/Ubuntu, RHEL, FreeBSD)

5. **desktop_apps_setup** (optional):
   - Installs desktop applications: Brave Browser, LibreOffice, VLC
   - Detects desktop environment (MATE, GNOME, XFCE, KDE)
   - OS-specific installation (Debian/Ubuntu, RHEL/CentOS, FreeBSD)
   - Interactive prompts in setup scripts for each application
   - Only runs when enabled via interactive prompts in setup scripts

6. **security_setup** (optional):
   - Deploys stateful firewall with default-deny inbound/outbound filtering
   - **Linux (Debian/Ubuntu, RHEL)**: nftables firewall (disables/masks firewalld on RHEL)
   - **FreeBSD**: PF firewall with pflogd logging
   - Allows SSH only from configurable subnets (CIDR ranges)
   - Allows DNS/DHCP and selected outbound (HTTP/HTTPS, SSH)
   - Logs outbound drops for visibility (integrated into `.bashrc` login display)
   - Configures log limits (500MB, 14-day retention)
   - Uses async/poll for firewall rule loading to prevent SSH connection drops
   - Only runs when enabled via interactive prompts in setup scripts

#### Features:
1. **Dynamic Role Execution:**
   - Executes all roles in sequence by default
   - All roles run automatically for complete setup

2. **Inventory Sections:**
   - The `hosts.ini` file is organized into sections:
     - `[local]`: For local machine setup
     - `[remote]`: For remote host setup (auto-populated by `setup_remote.sh`)

### hosts.ini format:
```
[local]
localhost ansible_connection=local ansible_user=root ansible_become=yes ansible_python_interpreter=/usr/bin/python3

[remote]
172.16.234.54 ansible_user=ansible ansible_python_interpreter=/usr/bin/python3
```

3. **User Configuration:**
   - Supports configuring specific users or all users on the system
   - Always configures root user in addition to selected users

---

### How to Use:

The recommended way to use localconfig is through the provided setup scripts (see sections above). However, you can also run the playbook directly:

#### Run All Roles (Default):
To execute all roles in sequence:
- **Locally:**
  ```bash
  ansible-playbook playbooks/site.yml -i hosts.ini -l local
  ```
- **Remotely:**
  ```bash
  ansible-playbook playbooks/site.yml -i hosts.ini -l remote
  ```

#### setup_local.sh

For convenience, I've included a bash script to deploy on a local system. So, besides ansible install and Python3 install, the only thing to do is 'git clone' this repo, add the ansible_user to sudoers en run the setup_local.sh

**Usage:**
```bash
./setup_local.sh
```

The script will:
- Check if Ansible is installed and install it if missing
- Create `hosts.ini` if it doesn't exist
- Run the playbook targeting the local machine
- Configure the current user and root with your localconfig files

---

### Remote VM Deployment

For deploying localconfig to remote VMs, two scripts are provided:

#### setup_client.sh

**Purpose:** Prepares a fresh VM for remote Ansible management. This script should be run **on the new VM** (as root or with sudo).

**What it does:**
- Detects OS (Debian/Ubuntu or RHEL/CentOS)
- Installs required packages: `git`, `sudo`, `sshpass`, `python3`, `python3-pip`
- Creates an `ansible` user
- Sets up SSH directory structure
- Adds the control host's SSH public key to authorized_keys
- Configures passwordless sudo access for the ansible user

**Usage:**
```bash
# Copy setup_client.sh to the new VM, then run:
sudo ./setup_client.sh
```

The script will show an interactive menu:
1. **Use default control machine SSH key** (recommended) - Uses a hardcoded default key
2. **Enter/paste a custom SSH public key** - Allows you to provide a different key

**Example:**
```bash
# On the new VM (as root):
sudo ./setup_client.sh
# Select option 1 or 2, then follow the prompts
```

#### setup_remote.sh

**Purpose:** Deploys localconfig to a remote VM using Ansible. This script runs **on the CONTROL HOST** (where the localconfig repo is cloned).

**What it does:**
- Validates Ansible installation
- Tests SSH connectivity to the remote host
- Automatically updates `hosts.ini` with the remote host
- Runs the full Ansible playbook to deploy localconfig
- Provides an interactive menu to select which user(s) to configure

**Usage:**
```bash
./setup_remote.sh <remote_host_ip_or_hostname> [ansible_user]
```

**Examples:**
```bash
# Deploy to remote host (default ansible user)
./setup_remote.sh 172.16.234.54

# Deploy to remote host with custom ansible user
./setup_remote.sh 172.16.234.54 ansible
```

**Interactive Configuration:**
When you run the script, you'll be prompted for:

1. **User Selection**: Which user(s) to configure:
   - **Ansible user and root only (default)** - Configures the `ansible` user and `root`
   - **Specific user** - Prompts for a username and configures that user (e.g., `rayf`)
   - **All users** - Configures all users on the system with home directories in `/home/`

2. **Additional Sudo Users**: Optional additional users to add to passwordless sudo

3. **MOTD Replacement**: Preview and optionally replace the existing MOTD

4. **Desktop Applications Setup** (optional):
   - Enable desktop applications setup?
   - Install Brave Browser? [y/N]
   - Install LibreOffice? [y/N]
   - Install VLC media player? [y/N]

5. **Firewall Configuration** (optional):
   - Enable firewall (security_setup role)?
   - SSH allowed source ranges (CIDR subnets)
   - DNS servers for outbound allow list

**Complete Workflow Example:**
```bash
# Step 1: On the new VM, prepare it for Ansible
sudo ./setup_client.sh
# Select option 1 (default SSH key) or option 2 (custom key)

# Step 2: On the control host, deploy localconfig
./setup_remote.sh 172.16.234.54
# Select option 1, 2, or 3 for user configuration
```

---

### Adding New Roles:
1. Add the new role to the `roles/` directory.
2. Include the role name in the `available_roles` list in `site.yml`.
3. The new role will automatically be recognized and can be run dynamically.

---

### Notes:
- Ensure that the roles you want to run are included in the `available_roles` list in `site.yml`.
- The playbook validates the roles specified in `selected_roles` to avoid errors.
- Change all.yml to contain the name of the standard user (which will be the ansible_user) on the target system
   - ansible_user: <add_local_user>

### Note
in RHEL there is no screen, they depprecated it in favor of tmux. Still need to convert my .screenrc to tmux config for RHEL usage only.

## Structure

```
localconfig/
│
├── group_vars/ 
│ └── all.yml
|
├── playbooks/
│ └── site.yml
│
├── discovered_ssh_keys/
│   ├── host1_keys.txt
│   ├── host2_keys.txt
│   └── ... (other files containing lists of public SSH keys from target systems)
│
├── roles/
│   ├── ssh_setup/
│   │   └── tasks/
│   │     └── main.yml
│   ├── tools_setup/
│   │   └── tasks/
│   │     └── main.yml
│   ├── vim_config/
│   │   └── tasks/
│   │     └── main.yml
│   ├── login_setup/
│   │   ├── tasks/
│   │   ├── templates/
│   │   └── handlers/
│   ├── desktop_apps_setup/
│   │   ├── tasks/
│   │   └── defaults/
│   ├── security_setup/
│   │   ├── tasks/
│   │   ├── templates/
│   │   └── defaults/
│   └── ... (other roles)
│
├── files/
│   ├── .vimrc
│   ├── .screenrc
│   ├── .bashrc
│   ├── .curlrc
│   │
│   ├── colors/
│   │   └── badwolf.vim
│   │
│   ├── plugin/
│   │   ├── airline.vim
│   │   └── airline-themes.vim
│   │
│   └── autoload/
│       └── ... (all the autoload files and directories for vim)
│
├── ansible.cfg
├── README.md
├── setup_local.sh
├── setup_client.sh
├── setup_remote.sh
└── hosts.ini
```

